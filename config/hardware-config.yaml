# Generated by Axovia Flow™ Agentic Framework

# Hardware Configuration for Multi-Sonicator-IO Web UI
# SOLE SOURCE OF TRUTH for hardware pin assignments
# Migrated from docs/planning/pin-matrix.md (now inactive)
# Changes here must be reflected in include/config.h and HIL wrapper

project:
  name: "multi-sonicator-io"
  description: "Sonicator Multiplexer - Hardware-in-the-Loop Testing"
  version: "1.0.0"
  status: "FINAL - Sole Source of Truth confirmed by Product Owner"

# Device Under Test (ATmega32A)
dut:
  microcontroller:
    type: "ATmega32A-PU"
    package: "DIP-40"
    clock_frequency: 16000000  # 16MHz
    voltage: 5.0
    manufacturer: "Microchip"

  # Pin definitions with complete pin matrix information
  pins:
    # Port B - Frequency inputs
    PB0:
      pin: 1
      signal: "FREQ_DIV10_4"
      direction: "IN"
      sonicator: 4
      header_ref: "DB9-4 Pin 4"
      scale_notes: "÷10 frequency (S4)"
      wrapper_pin: "D7"
      test_point: "TBD"

    PB1:
      pin: 2
      signal: "FREQ_DIV10_3"
      direction: "IN"
      sonicator: 3
      header_ref: "DB9-3 Pin 4"
      scale_notes: "÷10 frequency (S3)"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PB2:
      pin: 3
      signal: "FREQ_DIV10_2"
      direction: "IN"
      sonicator: 2
      header_ref: "DB9-2 Pin 4"
      scale_notes: "÷10 frequency (S2)"
      wrapper_pin: "N/A (Uno R4 single-channel)"
      test_point: "N/A"

    PB3:
      pin: 4
      signal: "FREQ_DIV10_1"
      direction: "IN"
      sonicator: 1
      header_ref: "DB9-1 Pin 4"
      scale_notes: "÷10 frequency (S1)"
      wrapper_pin: "N/A"
      test_point: "TBD"

    PB4:
      pin: 5
      signal: "FREQ_LOCK_4"
      direction: "IN"
      sonicator: 4
      header_ref: "DB9-4 Pin 3"
      scale_notes: "FLCK_4 via opto"
      wrapper_pin: "D8"
      test_point: "TBD"

    PB5:
      pin: 6
      signal: "FREQ_LOCK_3"
      direction: "IN"
      sonicator: 3
      header_ref: "DB9-3 Pin 3"
      scale_notes: "FLCK_3 via opto"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PB6:
      pin: 7
      signal: "FREQ_LOCK_2"
      direction: "IN"
      sonicator: 2
      header_ref: "DB9-2 Pin 3"
      scale_notes: "FLCK_2 via opto"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PB7:
      pin: 8
      signal: "FREQ_LOCK_1"
      direction: "IN"
      sonicator: 1
      header_ref: "DB9-1 Pin 3"
      scale_notes: "FLCK_1 via opto"
      wrapper_pin: "N/A"
      test_point: "TBD"

    # Port C - Control outputs
    PC0:
      pin: 22
      signal: "START_4"
      direction: "OUT"
      sonicator: 4
      header_ref: "DB9-4 Pin 7"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "A3"
      test_point: "TBD"

    PC1:
      pin: 23
      signal: "RESET_4"
      direction: "OUT"
      sonicator: 4
      header_ref: "DB9-4 Pin 2"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "A4"
      test_point: "TBD"

    PC2:
      pin: 24
      signal: "START_3"
      direction: "OUT"
      sonicator: 3
      header_ref: "DB9-3 Pin 7"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PC3:
      pin: 25
      signal: "RESET_3"
      direction: "OUT"
      sonicator: 3
      header_ref: "DB9-3 Pin 2"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PC4:
      pin: 26
      signal: "START_2"
      direction: "OUT"
      sonicator: 2
      header_ref: "DB9-2 Pin 7"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PC5:
      pin: 27
      signal: "RESET_2"
      direction: "OUT"
      sonicator: 2
      header_ref: "DB9-2 Pin 2"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PC6:
      pin: 28
      signal: "START_1"
      direction: "OUT"
      sonicator: 1
      header_ref: "DB9-1 Pin 7"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "N/A"
      test_point: "TBD"

    PC7:
      pin: 29
      signal: "RESET_1"
      direction: "OUT"
      sonicator: 1
      header_ref: "DB9-1 Pin 2"
      scale_notes: "ULN2003A open-collector"
      wrapper_pin: "N/A"
      test_point: "TBD"

    # Port D - Communication, status, and overload inputs
    PD0:
      pin: 14
      signal: "UART_RXD"
      direction: "IN"
      header_ref: "DB9-0 Pin 8"
      scale_notes: "MODBUS RTU RX"
      wrapper_pin: "D2 (drive to DUT RX)"
      test_point: "TBD"
      function: "MODBUS RTU RX"

    PD1:
      pin: 15
      signal: "UART_TXD"
      direction: "OUT"
      header_ref: "DB9-0 Pin 9"
      scale_notes: "MODBUS RTU TX"
      wrapper_pin: "D3 (read from DUT TX)"
      test_point: "TBD"
      function: "MODBUS RTU TX"

    PD2:
      pin: 16
      signal: "STATUS_LED"
      direction: "OUT"
      header_ref: "LED-TERM"
      scale_notes: "Status LED drive"
      wrapper_pin: "D4"
      test_point: "LED-TERM"
      function: "System status"

    PD3:
      pin: 17
      signal: "OVERLOAD_4"
      direction: "IN"
      sonicator: 4
      header_ref: "DB9-4 Pin 1"
      scale_notes: "OL_4 via opto"
      wrapper_pin: "A2"
      test_point: "TBD"

    PD4:
      pin: 18
      signal: "OVERLOAD_3"
      direction: "IN"
      sonicator: 3
      header_ref: "DB9-3 Pin 1"
      scale_notes: "OL_3 via opto"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PD5:
      pin: 19
      signal: "OVERLOAD_2"
      direction: "IN"
      sonicator: 2
      header_ref: "DB9-2 Pin 1"
      scale_notes: "OL_2 via opto"
      wrapper_pin: "N/A"
      test_point: "N/A"

    PD6:
      pin: 20
      signal: "OVERLOAD_1"
      direction: "IN"
      sonicator: 1
      header_ref: "DB9-1 Pin 1"
      scale_notes: "OL_1 via opto"
      wrapper_pin: "N/A"
      test_point: "TBD"

    PD7:
      pin: 21
      signal: "AMPLITUDE_ALL"
      direction: "OUT"
      header_ref: "DB9-1/2/3/4 Pin 8"
      scale_notes: "Shared AMP_C (0–10V), common"
      wrapper_pin: "D9 (PWM)"
      test_point: "TBD"
      function: "Shared amplitude control"

    # Port A - Analog power sensing
    PA4:
      pin: 36
      signal: "POWER_SENSE_1"
      direction: "ANALOG"
      sonicator: 1
      header_ref: "DB9-1 Pin 5"
      scale_notes: "5.44 mV/W scaling"
      wrapper_pin: "N/A"
      test_point: "TBD"
      scaling: "5.44 mV/W"

    PA5:
      pin: 35
      signal: "POWER_SENSE_2"
      direction: "ANALOG"
      sonicator: 2
      header_ref: "DB9-2 Pin 5"
      scale_notes: "5.44 mV/W scaling"
      wrapper_pin: "N/A"
      test_point: "N/A"
      scaling: "5.44 mV/W"

    PA6:
      pin: 34
      signal: "POWER_SENSE_3"
      direction: "ANALOG"
      sonicator: 3
      header_ref: "DB9-3 Pin 5"
      scale_notes: "5.44 mV/W scaling"
      wrapper_pin: "N/A"
      test_point: "N/A"
      scaling: "5.44 mV/W"

    PA7:
      pin: 33
      signal: "POWER_SENSE_4"
      direction: "ANALOG"
      sonicator: 4
      header_ref: "DB9-4 Pin 5"
      scale_notes: "5.44 mV/W scaling"
      wrapper_pin: "A1"
      test_point: "TBD"
      scaling: "5.44 mV/W"

# DB9 Connector Mapping
# Each channel uses its own DB9: DB9-1 (S1), DB9-2 (S2), DB9-3 (S3), DB9-4 (S4)
# System comms use DB9-0
# Pin map per channel DB9: Pin1=OVERLOAD, Pin2=RESET, Pin3=FREQ_LOCK, Pin4=FREQ÷10, Pin5=POWER, Pin7=START, Pin8=AMPLITUDE
# DB9-0: Pin8=UART_RXD, Pin9=UART_TXD
db9_connectors:
  DB9-0:
    description: "System communications connector (Modbus RTU network)"
    pins:
      8: { signal: "UART_RXD", dut_pin: "PD0" }
      9: { signal: "UART_TXD", dut_pin: "PD1" }

  DB9-1:
    description: "Sonicator 1 interface"
    pins:
      1: { signal: "OVERLOAD_1", dut_pin: "PD6" }
      2: { signal: "RESET_1", dut_pin: "PC7" }
      3: { signal: "FREQ_LOCK_1", dut_pin: "PB7" }
      4: { signal: "FREQ_DIV10_1", dut_pin: "PB3" }
      5: { signal: "POWER_SENSE_1", dut_pin: "PA4" }
      7: { signal: "START_1", dut_pin: "PC6" }
      8: { signal: "AMPLITUDE_ALL", dut_pin: "PD7" }

  DB9-2:
    description: "Sonicator 2 interface"
    pins:
      1: { signal: "OVERLOAD_2", dut_pin: "PD5" }
      2: { signal: "RESET_2", dut_pin: "PC5" }
      3: { signal: "FREQ_LOCK_2", dut_pin: "PB6" }
      4: { signal: "FREQ_DIV10_2", dut_pin: "PB2" }
      5: { signal: "POWER_SENSE_2", dut_pin: "PA5" }
      7: { signal: "START_2", dut_pin: "PC4" }
      8: { signal: "AMPLITUDE_ALL", dut_pin: "PD7" }

  DB9-3:
    description: "Sonicator 3 interface"
    pins:
      1: { signal: "OVERLOAD_3", dut_pin: "PD4" }
      2: { signal: "RESET_3", dut_pin: "PC3" }
      3: { signal: "FREQ_LOCK_3", dut_pin: "PB5" }
      4: { signal: "FREQ_DIV10_3", dut_pin: "PB1" }
      5: { signal: "POWER_SENSE_3", dut_pin: "PA6" }
      7: { signal: "START_3", dut_pin: "PC2" }
      8: { signal: "AMPLITUDE_ALL", dut_pin: "PD7" }

  DB9-4:
    description: "Sonicator 4 interface (fully connected in current prototype)"
    pins:
      1: { signal: "OVERLOAD_4", dut_pin: "PD3" }
      2: { signal: "RESET_4", dut_pin: "PC1" }
      3: { signal: "FREQ_LOCK_4", dut_pin: "PB4" }
      4: { signal: "FREQ_DIV10_4", dut_pin: "PB0" }
      5: { signal: "POWER_SENSE_4", dut_pin: "PA7" }
      7: { signal: "START_4", dut_pin: "PC0" }
      8: { signal: "AMPLITUDE_ALL", dut_pin: "PD7" }

# Test Harness (Arduino Uno R3)
harness:
  type: "Arduino Uno R3"
  microcontroller: "ATmega328P"
  clock_frequency: 16000000
  voltage: 5.0
  
  # Current single-channel prototype connections (Sonicator 4 only)
  connections:
    # MODBUS Communication
    D2: { dut_pin: "PD0", signal: "UART_RXD", direction: "harness_to_dut" }
    D3: { dut_pin: "PD1", signal: "UART_TXD", direction: "dut_to_harness" }
    
    # System monitoring
    D4: { dut_pin: "PD2", signal: "STATUS_LED", direction: "dut_to_harness" }
    
    # Sonicator 4 interface (fully connected)
    D7: { dut_pin: "PB0", signal: "FREQ_DIV10_4", direction: "harness_to_dut", sonicator: 4 }
    D8: { dut_pin: "PB4", signal: "FREQ_LOCK_4", direction: "harness_to_dut", sonicator: 4 }
    A2: { dut_pin: "PD3", signal: "OVERLOAD_4", direction: "harness_to_dut", sonicator: 4 }
    A3: { dut_pin: "PC0", signal: "START_4", direction: "dut_to_harness", sonicator: 4 }
    A4: { dut_pin: "PC1", signal: "RESET_4", direction: "dut_to_harness", sonicator: 4 }
    A1: { dut_pin: "PA7", signal: "POWER_SENSE_4", direction: "dut_to_harness", sonicator: 4 }
    D9: { dut_pin: "PD7", signal: "AMPLITUDE_ALL", direction: "dut_to_harness" }

# Sonicator specifications
sonicators:
  count: 4
  channels:
    - id: 1
      name: "sonicator1"
      db9_connector: "DB9-1"
      power_range: [0, 2000]  # Watts
      frequency_range: [18000, 22000]  # Hz - CT2000 operating range
      amplitude_range: [20, 100]  # Percent
      status: "not_connected"  # Current prototype limitation
      
    - id: 2
      name: "sonicator2"
      db9_connector: "DB9-2"
      power_range: [0, 2000]
      frequency_range: [18000, 22000]  # Hz - CT2000 operating range
      amplitude_range: [20, 100]
      status: "not_connected"  # Current prototype limitation
      
    - id: 3
      name: "sonicator3"
      db9_connector: "DB9-3"
      power_range: [0, 2000]
      frequency_range: [18000, 22000]  # Hz - CT2000 operating range
      amplitude_range: [20, 100]
      status: "not_connected"  # Current prototype limitation
      
    - id: 4
      name: "sonicator4"
      db9_connector: "DB9-4"
      power_range: [0, 2000]
      frequency_range: [18000, 22000]  # Hz - CT2000 operating range
      amplitude_range: [20, 100]
      status: "connected"  # Fully connected in current prototype

# Communication settings
communication:
  modbus:
    slave_id: 2
    baud_rate: 115200
    data_bits: 8
    stop_bits: 1
    parity: "none"
    timeout_ms: 1000

  serial:
    port: "/dev/tty.usbmodem2101"  # Arduino Uno R4 WiFi connected
    baud_rate: 115200
    timeout_ms: 5000

# Test capabilities
test_capabilities:
  - name: "modbus_communication"
    description: "MODBUS RTU protocol testing"
    pins: ["PD0", "PD1"]
    supported: true
    
  - name: "sonicator_4_control"
    description: "Complete sonicator 4 testing"
    pins: ["PB0", "PB4", "PD3", "PC0", "PC1", "PA7", "PD7"]
    supported: true
    
  - name: "power_measurement"
    description: "Power sensing validation"
    pins: ["PA7"]
    supported: true
    
  - name: "amplitude_control"
    description: "PWM amplitude control"
    pins: ["PD7"]
    supported: true
    
  - name: "safety_interlocks"
    description: "Safety system testing"
    pins: ["PC0", "PC1", "PD3"]
    supported: true
    
  - name: "multi_channel_testing"
    description: "All 4 sonicator channels"
    pins: ["all"]
    supported: false  # Future expansion
    note: "Requires 4-channel harness expansion"

# Hardware limitations
limitations:
  current_prototype: "Single-channel HIL harness"
  supported_channels: [4]
  unsupported_channels: [1, 2, 3]
  expansion_notes: "Channels 1-3 require additional harness connections"
  
# Environment settings
environment:
  simulation_mode: false  # REAL HARDWARE CONNECTED - Arduino Uno R4 WiFi at /dev/tty.usbmodem2101
  hardware_timeout_ms: 5000
  command_timeout_ms: 1000
  log_level: "info"

# Actions required when this configuration changes
actions_on_update:
  - description: "Update include/config.h to match matrix"
    details: "Update with doxygen comments citing this file and PRD sections"

  - description: "Update HIL wrapper constants"
    details: "Update test/acceptance/sketches/arduino_test_wrapper/arduino_test_wrapper.ino constants to match Wrapper Pins"

  - description: "Update test documentation"
    details: "Update test/acceptance/README.md harness diagram and mapping"

# References and documentation
references:
  - file: "docs/prd/prd-v1.0.0.md"
    sections: "Sections 5, 7, 10"
    description: "Product requirements document"

  - file: "include/config.h"
    description: "Register map, constants"

  - file: "docs/inactive/pin-matrix.md"
    description: "Original pin matrix document (now inactive)"

  - description: "Schematics/Hardware docs"
    details: "Pin headers and electrical characteristics"

# Migration notes
migration:
  date: "2025-01-10"
  from: "docs/planning/pin-matrix.md"
  reason: "Consolidate hardware configuration into single YAML source of truth"
  status: "Complete - pin-matrix.md moved to docs/inactive/"
