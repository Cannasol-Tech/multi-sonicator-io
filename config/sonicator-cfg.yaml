# Generated by Agile Flow™ Agentic Framework
# Multi-Sonicator-IO Sonicator Configuration
# SOLE SOURCE OF TRUTH for CT2000 sonicator specifications and operational parameters

metadata:
  name: "sonicator-configuration"
  description: "CT2000 sonicator specifications, operational limits, and channel definitions"
  author: "Stephen Boyett"
  company: "Cannasol Technologies"
  last_updated: "2025-09-16"
  version: "1.0.0"

# ============================================================================
# SYSTEM-LEVEL SONICATOR CONFIGURATION
# ============================================================================

system:
  total_channels: 4
  manufacturer: "Crest Ultrasonics"
  model_series: "CT2000"
  description: "Industrial ultrasonic cleaning system with multiplexed control"
  
  # Global operational parameters
  global_limits:
    max_simultaneous_active: 4    # All sonicators can run simultaneously
    shared_amplitude_control: true # Single amplitude control for all units
    amplitude_range_percent: [20, 100]  # Safety-limited range
    power_supply_max_watts: 8000  # Total system power capacity
    
  # Safety and protection systems
  safety:
    emergency_stop_available: true
    overload_protection: true
    frequency_lock_monitoring: true
    thermal_protection: true
    isolation_barriers: true
    
  # Control architecture
  control:
    individual_start_stop: true
    individual_overload_reset: true
    shared_amplitude: true
    independent_monitoring: true

# ============================================================================
# INDIVIDUAL SONICATOR CHANNEL DEFINITIONS
# ============================================================================

sonicators:
  # Sonicator Channel 1
  - id: 1
    name: "sonicator1"
    description: "CT2000 Ultrasonic Cleaning Unit #1"
    
    # Hardware interface
    hardware:
      db9_connector: "DB9-1"
      modbus_base_address: 0x0100
      register_stride: 0x20
      
    # CT2000 Specifications
    specifications:
      model: "CT2000-1800"
      power_rating_watts: 1800
      frequency_nominal_hz: 20000
      frequency_range_hz: [17000, 22000]
      amplitude_range_percent: [20, 100]
      duty_cycle_max_percent: 100
      
    # Operational parameters
    operational:
      power_range_watts: [0, 1800]
      frequency_range_hz: [18000, 22000]  # Actual operating range
      amplitude_range_percent: [20, 100]  # Safety-limited
      startup_time_seconds: 2
      shutdown_time_seconds: 1
      
    # Monitoring and sensing
    monitoring:
      power_sensing:
        enabled: true
        adc_channel: 4
        dut_pin: "PA4"
        scaling_factor: "5.44 mV/W"
        max_voltage: 8.16  # 1500W × 5.44mV/W = 8.16V
        resolution_bits: 10
        
      frequency_monitoring:
        enabled: true
        dut_pin: "PB3"
        method: "÷10 frequency counter"
        range_hz: [1700, 2200]  # ÷10 of actual frequency
        
      overload_detection:
        enabled: true
        dut_pin: "PD6"
        method: "opto-isolated digital input"
        active_state: "high"
        
      frequency_lock_detection:
        enabled: true
        dut_pin: "PB7"
        method: "opto-isolated digital input"
        active_state: "high"
        
    # Control outputs
    control:
      start_stop:
        enabled: true
        dut_pin: "PC6"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        
      overload_reset:
        enabled: true
        dut_pin: "PC7"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        pulse_duration_ms: 100
        
      amplitude_control:
        enabled: true
        dut_pin: "PD7"
        method: "shared PWM output"
        range_voltage: [0, 10]
        shared_with: [2, 3, 4]
        
    # Current status and limitations
    status:
      connection_status: "not_connected"
      test_harness_support: false
      production_ready: true
      notes: "Requires harness expansion for HIL testing"

  # Sonicator Channel 2
  - id: 2
    name: "sonicator2"
    description: "CT2000 Ultrasonic Cleaning Unit #2"
    
    # Hardware interface
    hardware:
      db9_connector: "DB9-2"
      modbus_base_address: 0x0120
      register_stride: 0x20
      
    # CT2000 Specifications
    specifications:
      model: "CT2000-1800"
      power_rating_watts: 1800
      frequency_nominal_hz: 20000
      frequency_range_hz: [17000, 22000]
      amplitude_range_percent: [20, 100]
      duty_cycle_max_percent: 100
      
    # Operational parameters
    operational:
      power_range_watts: [0, 1800]
      frequency_range_hz: [18000, 22000]
      amplitude_range_percent: [20, 100]
      startup_time_seconds: 2
      shutdown_time_seconds: 1
      
    # Monitoring and sensing
    monitoring:
      power_sensing:
        enabled: true
        adc_channel: 5
        dut_pin: "PA5"
        scaling_factor: "5.44 mV/W"
        max_voltage: 8.16
        resolution_bits: 10
        
      frequency_monitoring:
        enabled: true
        dut_pin: "PB2"
        method: "÷10 frequency counter"
        range_hz: [1700, 2200]
        
      overload_detection:
        enabled: true
        dut_pin: "PD5"
        method: "opto-isolated digital input"
        active_state: "high"
        
      frequency_lock_detection:
        enabled: true
        dut_pin: "PB6"
        method: "opto-isolated digital input"
        active_state: "high"
        
    # Control outputs
    control:
      start_stop:
        enabled: true
        dut_pin: "PC4"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        
      overload_reset:
        enabled: true
        dut_pin: "PC5"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        pulse_duration_ms: 100
        
      amplitude_control:
        enabled: true
        dut_pin: "PD7"
        method: "shared PWM output"
        range_voltage: [0, 10]
        shared_with: [1, 3, 4]
        
    # Current status and limitations
    status:
      connection_status: "not_connected"
      test_harness_support: false
      production_ready: true
      notes: "Requires harness expansion for HIL testing"

  # Sonicator Channel 3
  - id: 3
    name: "sonicator3"
    description: "CT2000 Ultrasonic Cleaning Unit #3"
    
    # Hardware interface
    hardware:
      db9_connector: "DB9-3"
      modbus_base_address: 0x0140
      register_stride: 0x20
      
    # CT2000 Specifications
    specifications:
      model: "CT2000-1800"
      power_rating_watts: 1800
      frequency_nominal_hz: 20000
      frequency_range_hz: [17000, 22000]
      amplitude_range_percent: [20, 100]
      duty_cycle_max_percent: 100
      
    # Operational parameters
    operational:
      power_range_watts: [0, 1800]
      frequency_range_hz: [18000, 22000]
      amplitude_range_percent: [20, 100]
      startup_time_seconds: 2
      shutdown_time_seconds: 1
      
    # Monitoring and sensing
    monitoring:
      power_sensing:
        enabled: true
        adc_channel: 6
        dut_pin: "PA6"
        scaling_factor: "5.44 mV/W"
        max_voltage: 8.16
        resolution_bits: 10
        
      frequency_monitoring:
        enabled: true
        dut_pin: "PB1"
        method: "÷10 frequency counter"
        range_hz: [1700, 2200]
        
      overload_detection:
        enabled: true
        dut_pin: "PD4"
        method: "opto-isolated digital input"
        active_state: "high"
        
      frequency_lock_detection:
        enabled: true
        dut_pin: "PB5"
        method: "opto-isolated digital input"
        active_state: "high"
        
    # Control outputs
    control:
      start_stop:
        enabled: true
        dut_pin: "PC2"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        
      overload_reset:
        enabled: true
        dut_pin: "PC3"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        pulse_duration_ms: 100
        
      amplitude_control:
        enabled: true
        dut_pin: "PD7"
        method: "shared PWM output"
        range_voltage: [0, 10]
        shared_with: [1, 2, 4]
        
    # Current status and limitations
    status:
      connection_status: "not_connected"
      test_harness_support: false
      production_ready: true
      notes: "Requires harness expansion for HIL testing"

  # Sonicator Channel 4 (Fully Connected)
  - id: 4
    name: "sonicator4"
    description: "CT2000 Ultrasonic Cleaning Unit #4 (Primary test channel)"
    
    # Hardware interface
    hardware:
      db9_connector: "DB9-4"
      modbus_base_address: 0x0160
      register_stride: 0x20
      
    # CT2000 Specifications
    specifications:
      model: "CT2000-1800"
      power_rating_watts: 1800
      frequency_nominal_hz: 20000
      frequency_range_hz: [17000, 22000]
      amplitude_range_percent: [20, 100]
      duty_cycle_max_percent: 100
      
    # Operational parameters
    operational:
      power_range_watts: [0, 1800]
      frequency_range_hz: [18000, 22000]
      amplitude_range_percent: [20, 100]
      startup_time_seconds: 2
      shutdown_time_seconds: 1
      
    # Monitoring and sensing
    monitoring:
      power_sensing:
        enabled: true
        adc_channel: 7
        dut_pin: "PA7"
        scaling_factor: "5.44 mV/W"
        max_voltage: 8.16
        resolution_bits: 10
        test_harness_pin: "A1"
        
      frequency_monitoring:
        enabled: true
        dut_pin: "PB0"
        method: "÷10 frequency counter"
        range_hz: [1700, 2200]
        test_harness_pin: "D7"
        
      overload_detection:
        enabled: true
        dut_pin: "PD3"
        method: "opto-isolated digital input"
        active_state: "high"
        test_harness_pin: "A2"
        
      frequency_lock_detection:
        enabled: true
        dut_pin: "PB4"
        method: "opto-isolated digital input"
        active_state: "high"
        test_harness_pin: "D8"
        
    # Control outputs
    control:
      start_stop:
        enabled: true
        dut_pin: "PC0"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        test_harness_pin: "A3"
        
      overload_reset:
        enabled: true
        dut_pin: "PC1"
        method: "open-collector output"
        driver: "ULN2003A"
        active_state: "low"
        pulse_duration_ms: 100
        test_harness_pin: "A4"
        
      amplitude_control:
        enabled: true
        dut_pin: "PD7"
        method: "shared PWM output"
        range_voltage: [0, 10]
        shared_with: [1, 2, 3]
        test_harness_pin: "D9"
        
    # Current status and capabilities
    status:
      connection_status: "connected"
      test_harness_support: true
      production_ready: true
      notes: "Fully connected and tested in current prototype"

# ============================================================================
# OPERATIONAL MODES AND SEQUENCES
# ============================================================================

operational_modes:
  # Individual Operation
  individual:
    description: "Single sonicator operation"
    max_active: 1
    power_limit_watts: 1800
    startup_sequence: "direct"
    
  # Dual Operation
  dual:
    description: "Two sonicator simultaneous operation"
    max_active: 2
    power_limit_watts: 3600
    startup_sequence: "staggered"
    stagger_delay_ms: 500
    
  # Triple Operation
  triple:
    description: "Three sonicator simultaneous operation"
    max_active: 3
    power_limit_watts: 5400
    startup_sequence: "staggered"
    stagger_delay_ms: 500
    
  # Quad Operation
  quad:
    description: "All four sonicators simultaneous operation"
    max_active: 4
    power_limit_watts: 7200
    startup_sequence: "staggered"
    stagger_delay_ms: 500
    power_management: "load_balancing"

# Startup and shutdown sequences
sequences:
  startup:
    - step: 1
      action: "verify_system_ready"
      timeout_ms: 1000
      
    - step: 2
      action: "set_amplitude"
      parameter: "target_amplitude_percent"
      
    - step: 3
      action: "enable_sonicator"
      parameter: "sonicator_id"
      delay_ms: 500
      
    - step: 4
      action: "verify_frequency_lock"
      timeout_ms: 5000
      
    - step: 5
      action: "monitor_power_level"
      continuous: true
      
  shutdown:
    - step: 1
      action: "disable_sonicator"
      parameter: "sonicator_id"
      
    - step: 2
      action: "verify_power_down"
      timeout_ms: 2000
      
    - step: 3
      action: "reset_amplitude"
      parameter: 0

# Safety interlocks and protection
safety_interlocks:
  overload_protection:
    enabled: true
    auto_reset: false
    manual_reset_required: true
    lockout_time_seconds: 30
    
  frequency_lock_monitoring:
    enabled: true
    timeout_seconds: 10
    action_on_loss: "shutdown"
    
  thermal_protection:
    enabled: true
    method: "external_monitoring"
    action_on_fault: "emergency_stop"
    
  power_limit_protection:
    enabled: true
    individual_limit_watts: 1800
    system_limit_watts: 7200
    action_on_exceed: "load_shedding"

# Test capabilities and limitations
test_capabilities:
  supported_tests:
    - "Individual sonicator control (Channel 4)"
    - "Power measurement validation"
    - "Frequency monitoring accuracy"
    - "Overload detection response"
    - "Amplitude control linearity"
    - "MODBUS communication"
    - "Safety interlock verification"
    
  limitations:
    current_prototype: "Single-channel HIL harness"
    supported_channels: [4]
    unsupported_channels: [1, 2, 3]
    expansion_notes: "Channels 1-3 require additional harness connections"
    
  future_expansion:
    description: "4-channel harness expansion"
    hardware_required: "Arduino Mega 2560 or custom PCB"
    estimated_development_time: "2-3 weeks"
    additional_pins_required: 21  # 7 pins × 3 additional channels

# References and cross-references
references:
  ct2000_manual: "docs/hardware/CT2000_User_Manual.pdf"
  pinout_config: "config/pinout-cfg.yaml"
  connections_config: "config/connections-cfg.yaml"
  communication_config: "config/communication-cfg.yaml"
  modbus_registers: "include/register_map.h"
  safety_standards: "docs/safety/industrial_safety_requirements.md"

# Change management
change_management:
  update_requirements:
    - "Update MODBUS register definitions"
    - "Update HAL sonicator control functions"
    - "Update safety interlock logic"
    - "Update test procedures and validation"
    - "Update operational documentation"
    
  validation_checklist:
    - "Verify power ratings and limits"
    - "Confirm frequency ranges and accuracy"
    - "Validate safety interlock operation"
    - "Test amplitude control linearity"
    - "Verify MODBUS register mappings"
    - "Confirm connector pinout assignments"
