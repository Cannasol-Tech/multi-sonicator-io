# Story 0.2: HIL Test Harness Setup

## Status
Draft

## Story
**As a** Test Engineer,
**I want** a comprehensive Hardware-in-the-Loop (HIL) test harness,
**so that** I can validate firmware behavior against actual hardware and ensure reliable integration before deployment.

## Acceptance Criteria

1. Physical hardware test harness operational with Arduino Test Wrapper
2. ATmega32A Sonicator Multiplexer DUT properly connected and powered
3. ISP programming interface functional for firmware deployment
4. Hardware abstraction layer for test automation
5. Test signal generation and monitoring capabilities
6. Automated test execution with hardware validation
7. Test result collection and reporting from physical hardware
8. Safety interlocks and emergency stop procedures
9. Hardware configuration validation against pin matrix
10. Integration with CI/CD pipeline for automated HIL testing

## Tasks / Subtasks

- [ ] Task 1: Physical Hardware Setup (AC: 1, 2, 3)
  - [ ] Configure Arduino Uno R4 WiFi as ISP programmer and test wrapper
  - [ ] Set up ATmega32A Sonicator Multiplexer DUT hardware
  - [ ] Establish power supply and regulation (24V → 12V → 5V)
  - [ ] Verify all DB9 connections and pin assignments
  - [ ] Test ISP programming interface functionality

- [ ] Task 2: Hardware Abstraction Layer (AC: 4, 6)
  - [ ] Implement test wrapper communication protocol
  - [ ] Create hardware abstraction for test automation
  - [ ] Develop test signal generation capabilities
  - [ ] Implement hardware monitoring and data collection
  - [ ] Create test execution control interface

- [ ] Task 3: Test Signal Management (AC: 5, 7)
  - [ ] Implement GPIO signal generation and monitoring
  - [ ] Set up ADC monitoring for analog signals
  - [ ] Configure PWM signal generation for testing
  - [ ] Implement UART communication testing
  - [ ] Create test data logging and collection

- [ ] Task 4: Safety and Validation Systems (AC: 8, 9)
  - [ ] Implement emergency stop and safety interlocks
  - [ ] Create hardware configuration validation
  - [ ] Verify pin matrix against config/hardware-config.yaml
  - [ ] Implement overload protection and monitoring
  - [ ] Set up hardware fault detection and reporting

- [ ] Task 5: Automation Integration (AC: 10)
  - [ ] Integrate HIL testing with CI/CD pipeline
  - [ ] Create automated test scheduling and execution
  - [ ] Implement test result reporting and archiving
  - [ ] Set up hardware availability monitoring
  - [ ] Configure test environment management

## Dev Notes

### Testing Standards
- **HIL Framework**: Custom test harness with Arduino Test Wrapper
- **Test Execution**: Automated via CI/CD with manual override capability
- **Hardware Validation**: All tests must pass on physical hardware
- **Safety Requirements**: Emergency stop within 100ms, overload protection
- **Test Isolation**: Each test must reset hardware to known state

### Architecture Context
- **Test Hardware**: Arduino Uno R4 WiFi as ISP programmer and test wrapper
- **DUT**: ATmega32A Sonicator Multiplexer (32KB Flash, 2KB SRAM)
- **Communication**: UART for test control, ISP for firmware programming
- **Power System**: 24V input → 12V → 5V regulation cascade
- **Interfaces**: 4x DB9 sonicator interfaces + 1x DB9 MODBUS communication

### Technical Constraints
- **Hardware Limitations**: Physical hardware availability for testing
- **Timing Requirements**: Real-time signal generation and monitoring
- **Safety Critical**: Must prevent hardware damage during testing
- **Environmental**: Industrial temperature and EMC considerations
- **Reliability**: 99.9% test harness uptime requirement

### File Locations
- **HIL Framework**: test/hil/ (hardware-in-the-loop test code)
- **Test Wrapper**: test/wrapper/ (Arduino test wrapper firmware)
- **Hardware Config**: config/hardware-config.yaml (pin assignments)
- **Test Scripts**: test/scripts/ (automation and execution scripts)
- **Test Data**: test/data/ (test results and logs)

### Hardware Pin Matrix Reference
- **Source of Truth**: config/hardware-config.yaml
- **Arduino Pins**: Digital I/O, analog inputs, PWM outputs
- **ATmega32A Pins**: GPIO, ADC, PWM, UART interfaces
- **DB9 Connections**: Sonicator interfaces and MODBUS communication
- **Power Pins**: 24V input, 12V/5V regulation monitoring

### Previous Story Insights
- Depends on Story 0.1 for project structure and CI/CD foundation
- Critical for all subsequent hardware validation stories
- Must establish hardware testing patterns for future stories

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 1.0 | Created story for HIL test harness setup | Product Owner |
