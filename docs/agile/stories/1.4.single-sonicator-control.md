# Story 1.4: Single Sonicator Control Implementation

**Story ID**: S-1.4
**Epic**: Epic 1: Foundational Control & Communication
**Priority**: High
**Owner**: Product Owner
**Created**: 2025-09-10
**Updated**: 2025-09-10

## Status

NotStarted

## User Story

As a firmware engineer,
I want to implement basic control and monitoring of a single sonicator unit via the ATmega32A,
so that the system can start/stop and modulate amplitude while reporting status through the standardized interface.

## Scope

- Implement start/stop and amplitude control primitives
- Monitor essential telemetry (state, faults/overload, amplitude feedback if available)
- Expose control/telemetry over MODBUS register interface
- Integrate with HIL framework for end-to-end validation
- Align with S4-only simulation/wrapper mapping per `config/hardware-config.yaml` (SOLE SOURCE OF TRUTH)

## Acceptance Criteria

1. Start/stop commands change output state reliably and within expected timing
2. Amplitude setpoint accepted and applied within tolerance (define % tolerance)
3. Telemetry registers report current state and any fault/overload conditions
4. MODBUS RTU operations for these controls/telemetry succeed within 100ms
5. HIL acceptance tests validate the full control loop on hardware

## Tasks

- [ ] Define and document control/telemetry registers in `include/register_map.h`
- [ ] Implement control handlers (start/stop/amplitude) in control module
- [ ] Implement telemetry update path and fault/overload detection
- [ ] Wire control/telemetry into MODBUS slave handlers
- [ ] Add HIL tests to exercise start/stop/amplitude and verify telemetry
- [ ] Validate against S4-only wrapper mapping; update docs if mappings change

## Definition of Done

- [ ] All acceptance criteria satisfied on bench hardware
- [ ] HIL tests passing; artifacts preserved in `test/acceptance/logs/`
- [ ] Documentation updated (control flows, register tables, pin mapping reference)

## Links

- Epic: `docs/agile/epics/epic-1-foundational-control-communication.md`
- Hardware Config (SOLE SOURCE OF TRUTH): `config/hardware-config.yaml`
