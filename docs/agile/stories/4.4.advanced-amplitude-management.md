---
# <!-- Generated by •∆• ~•Axovia•ƒløw™•~ -->
id: S-4.4
title: Advanced Amplitude Management - Per-Unit Setpoint Control with Ramping and Limits
status: draft
updated_at: 2025-09-14
version: 1.0
provenance:
  banner: "<!-- Generated by •∆• ~•Axovia•ƒløw™•~ -->"
---
# Story 4.4: Advanced Amplitude Management - Per-Unit Setpoint Control with Ramping and Limits

## Status

Draft

## Story

**As a** Process Control Engineer,
**I want** advanced amplitude management with per-unit setpoint control, ramping capabilities, and safety limits,
**so that** I can achieve precise amplitude control for each sonicator unit with smooth transitions, safety protection, and optimal process performance.

## Acceptance Criteria

1. Per-unit amplitude setpoint control with 0.1% resolution (0-100% range)
2. Amplitude ramping with configurable ramp rates for smooth transitions
3. Individual amplitude safety limits and validation per sonicator unit
4. Real-time amplitude monitoring and feedback for all units
5. Amplitude calibration and compensation for individual unit variations
6. Emergency amplitude limiting and safety shutdown capabilities
7. Amplitude profile management with preset configurations
8. Real-time amplitude adjustment during operation without interruption
9. Amplitude control response time <50ms for immediate adjustments
10. Amplitude data logging and performance monitoring for optimization

## Tasks / Subtasks

- [ ] Task 1: Per-Unit Amplitude Control (AC: 1, 8, 9)
  - [ ] Implement per-unit amplitude setpoint control with 0.1% resolution
  - [ ] Create real-time amplitude adjustment capabilities during operation
  - [ ] Add amplitude control response optimization for <50ms timing
  - [ ] Implement individual amplitude control algorithms per unit
  - [ ] Create amplitude setpoint validation and range checking

- [ ] Task 2: Amplitude Ramping and Transitions (AC: 2)
  - [ ] Implement amplitude ramping with configurable ramp rates
  - [ ] Create smooth amplitude transition algorithms
  - [ ] Add ramp rate validation and safety checks
  - [ ] Implement ramping control with start/stop/pause capabilities
  - [ ] Create ramping status monitoring and feedback

- [ ] Task 3: Safety Limits and Validation (AC: 3, 6)
  - [ ] Implement individual amplitude safety limits per sonicator unit
  - [ ] Add amplitude validation and bounds checking
  - [ ] Create emergency amplitude limiting and safety shutdown
  - [ ] Implement amplitude safety monitoring and fault detection
  - [ ] Add amplitude safety interlock integration

- [ ] Task 4: Monitoring and Calibration (AC: 4, 5, 10)
  - [ ] Implement real-time amplitude monitoring and feedback systems
  - [ ] Add amplitude calibration and compensation for unit variations
  - [ ] Create amplitude data logging and performance monitoring
  - [ ] Implement amplitude accuracy validation and correction
  - [ ] Add amplitude performance metrics and optimization

- [ ] Task 5: Profile Management and Configuration (AC: 7)
  - [ ] Implement amplitude profile management with preset configurations
  - [ ] Create amplitude profile storage and retrieval systems
  - [ ] Add profile validation and safety checking
  - [ ] Implement profile switching and management during operation
  - [ ] Create amplitude configuration backup and restore capabilities

## Dev Notes

### Previous Story Insights
- Individual control systems (Story 4.2) provide foundation for per-unit amplitude control
- Multi-unit state management (Story 4.1) provides coordination framework
- Single sonicator control (Story 1.4) established basic amplitude control principles
- Advanced amplitude management builds on existing control with enhanced features

### Architecture Context

**Amplitude Control Architecture**: PWM-based amplitude control with feedback [Source: docs/architecture/architecture.md]
- PWM generation for amplitude control via RC filtering
- Individual amplitude control per sonicator unit
- Real-time amplitude monitoring and feedback
- Hardware abstraction layer for amplitude interface

**Hardware Interface**: Amplitude control and monitoring [Source: config/hardware-config.yaml]
- PWM output for amplitude control (0-10V analog output)
- Amplitude feedback monitoring via ADC
- Individual amplitude control per sonicator unit
- Hardware safety limits and protection circuits

**Control Algorithm Design**: Advanced amplitude control with ramping and safety
- PID control algorithms for precise amplitude regulation
- Ramping algorithms for smooth amplitude transitions
- Safety limit enforcement with immediate response
- Calibration and compensation for unit variations

### Technical Specifications

**Amplitude Control Structure**:
```cpp
struct AmplitudeController {
  uint8_t unit_id;
  uint16_t setpoint;           // 0-1000 (0-100.0%)
  uint16_t current_amplitude;  // Real-time amplitude reading
  uint16_t min_limit;          // Safety minimum limit
  uint16_t max_limit;          // Safety maximum limit
  uint16_t ramp_rate;          // Amplitude change rate (%/sec)
  bool ramping_active;
  uint32_t last_update_time;
};
```

**Amplitude Control Ranges**:
- Setpoint range: 0-100% with 0.1% resolution (0-1000 internal units)
- Ramp rates: 0.1-100%/second configurable per unit
- Safety limits: Configurable per unit with validation
- Response time: <50ms for amplitude adjustments

**Ramping Control**:
- Configurable ramp rates for smooth amplitude transitions
- Ramping start/stop/pause control capabilities
- Ramp completion detection and notification
- Emergency ramp abort for safety scenarios

**Safety and Validation**:
- Individual amplitude safety limits per unit
- Real-time amplitude bounds checking and validation
- Emergency amplitude limiting and shutdown
- Amplitude safety interlock integration

### File Locations
- **Amplitude Controller**: `src/control/AmplitudeController.cpp` (main amplitude control logic)
- **Ramping Control**: `src/control/AmplitudeRamping.cpp` (ramping algorithms and control)
- **Safety Systems**: `src/safety/AmplitudeSafety.cpp` (amplitude safety and limits)
- **Calibration**: `src/calibration/AmplitudeCalibration.cpp` (calibration and compensation)
- **Profile Management**: `src/config/AmplitudeProfiles.cpp` (profile storage and management)
- **Hardware Interface**: `src/hal/AmplitudeHAL.cpp` (hardware abstraction for amplitude)

### Testing Requirements
- **Unit Testing**: Amplitude control algorithms and ramping functionality
- **Integration Testing**: Amplitude control with hardware interface and safety systems
- **HIL Testing**: Hardware-in-the-loop testing with amplitude feedback validation
- **Performance Testing**: Amplitude control response time and accuracy validation
- **Safety Testing**: Amplitude safety limits and emergency shutdown testing

### Technical Constraints
- **Resolution**: 0.1% amplitude resolution with stable control
- **Response Time**: <50ms for amplitude control adjustments
- **Safety**: Immediate amplitude limiting and emergency shutdown capabilities
- **Accuracy**: ±1% amplitude accuracy with calibration and compensation
- **Stability**: Stable amplitude control without oscillation or drift

### Amplitude Control Features
- **Precise Control**: 0.1% resolution with real-time adjustment capabilities
- **Smooth Ramping**: Configurable ramp rates for optimal process transitions
- **Safety Protection**: Individual safety limits and emergency shutdown
- **Calibration**: Per-unit calibration and compensation for accuracy
- **Profile Management**: Preset amplitude configurations for different processes

### Ramping Control Features
- **Configurable Rates**: 0.1-100%/second ramp rates per unit
- **Smooth Transitions**: Optimized ramping algorithms for process stability
- **Control Capabilities**: Start/stop/pause ramping with real-time control
- **Safety Integration**: Emergency ramp abort and safety limit enforcement
- **Status Monitoring**: Real-time ramping status and completion detection

### Safety and Monitoring
- **Safety Limits**: Individual amplitude limits per unit with validation
- **Emergency Control**: Immediate amplitude limiting and shutdown capabilities
- **Real-time Monitoring**: Continuous amplitude monitoring and feedback
- **Performance Tracking**: Amplitude accuracy and stability monitoring
- **Fault Detection**: Amplitude control fault detection and recovery

### Integration Points
- **Individual Control**: Integration with individual unit control systems (Story 4.2)
- **State Management**: Coordination with multi-unit state management (Story 4.1)
- **Safety Systems**: Integration with safety interlocks and monitoring
- **Hardware Interface**: Amplitude control hardware abstraction and interface
- **Monitoring Systems**: Real-time amplitude monitoring and performance tracking

### Performance Optimization
- **Control Algorithms**: Optimized PID control for fast and stable response
- **Memory Usage**: Efficient data structures for amplitude control state
- **Hardware Interface**: Optimized PWM generation and ADC reading
- **Real-time Operation**: Deterministic timing for amplitude control updates
- **Calibration**: Efficient calibration algorithms for accuracy optimization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Created story for advanced amplitude management with ramping and safety | Bob (Scrum Master) |
