# Story 1.5: Sandbox CLI for Manual Testing

**Story ID**: S-1.5
**Feature**: F-002: HIL Testing Framework & Hardware Verification
**Priority**: Medium
**Owner**: Product Owner (Sarah)
**Created**: 2025-09-10
**Updated**: 2025-09-10

## Status

Draft

## Story

**As a** firmware developer and hardware engineer,
**I want** a command-line sandbox tool for manual hardware control and debugging,
**so that** I can quickly test individual hardware functions, debug issues, and validate hardware behavior interactively.

## Feature Context

**Feature F-002: HIL Testing Framework & Hardware Verification**

- Goal: Provide manual testing capabilities complementing automated HIL and BDD frameworks
- Enables rapid debugging and interactive hardware exploration during development

## Story Context

**Sandbox CLI Capabilities:**

- Interactive command-line interface for hardware control
- Direct access to HIL controller functions for debugging
- Real-time hardware state monitoring and logging
- Support for manual test sequences and debugging workflows

**Integration Points:**

- HIL test harness for hardware interface
- Arduino Test Wrapper for direct hardware control
- Command-line interface for developer interaction
- Logging and diagnostic output for debugging

## Acceptance Criteria

**CLI Interface Requirements:**

1. Sandbox CLI provides interactive shell for manual hardware control commands
2. CLI supports direct control of all sonicator functions (start, stop, reset for channels 1-4)
3. Real-time display of hardware signals (FREQ_LOCK, OVERLOAD, PWR_MONITOR) with refresh capability
4. Amplitude control commands with validation and safety bounds (0-100% range)

**Hardware Control and Monitoring:**

5. MODBUS register read/write commands with immediate hardware execution
6. Pin control commands for direct GPIO manipulation and testing
7. Signal monitoring commands with configurable sampling rates and duration
8. Hardware state snapshot commands for debugging and issue diagnosis

**Developer Experience:**

9. CLI accessible via `make hardware-sandbox` with clear usage instructions
10. Command history and autocomplete for common operations and hardware addresses
11. Comprehensive help system with examples for all commands and use cases
12. Logging output with timestamps and hardware state changes for debugging

## Technical Implementation Details

### CLI Command Structure

```bash
# Start sandbox CLI
make hardware-sandbox

# Example CLI session
sandbox> sonicator 1 start          # Start sonicator 1
sandbox> sonicator 1 status         # Check sonicator 1 status
sandbox> amplitude set 75           # Set amplitude to 75%
sandbox> monitor freq_lock 1        # Monitor frequency lock signal for sonicator 1
sandbox> modbus read 0x0010          # Read MODBUS register 0x0010
sandbox> modbus write 0x0010 1      # Write value 1 to register 0x0010
sandbox> pin read PC6               # Read pin PC6 state
sandbox> pin write PC6 high         # Set pin PC6 high
sandbox> snapshot                   # Take hardware state snapshot
sandbox> help                       # Display available commands
sandbox> exit                       # Exit sandbox
```

### Command Categories

**Sonicator Control:**
- `sonicator <1-4> start|stop|reset|status`
- `amplitude get|set <0-100>`
- `system status` - overall system state

**Signal Monitoring:**
- `monitor <signal_name> [duration]` - real-time monitoring
- `watch <register_addr>` - watch MODBUS register changes
- `pins status` - all pin states

**Direct Hardware Control:**
- `pin read|write <pin_name> [value]`
- `modbus read|write <addr> [value]`
- `adc read <channel>` - read ADC values

**Debugging and Diagnostics:**
- `snapshot [filename]` - hardware state capture
- `log start|stop [filename]` - enable/disable logging
- `trace <command>` - execute command with detailed tracing

## Definition of Done

- [ ] Sandbox CLI provides interactive shell for hardware control
- [ ] CLI supports direct control of all sonicator functions (channels 1-4)
- [ ] Real-time hardware signal display with refresh capability
- [ ] Amplitude control with validation and safety bounds
- [ ] MODBUS register read/write with immediate hardware execution
- [ ] Pin control commands for GPIO manipulation and testing
- [ ] Signal monitoring with configurable sampling and duration
- [ ] Hardware state snapshot capability for debugging
- [ ] CLI accessible via `make hardware-sandbox` with clear instructions
- [ ] Command history and autocomplete for common operations
- [ ] Comprehensive help system with examples
- [ ] Logging output with timestamps and state changes
- [ ] Ready for integration with complete HIL framework

## Tasks / Subtasks

- [ ] **Task 1: CLI Framework and Interface** (AC: 1, 9, 10)
  - [ ] Implement interactive CLI shell with command parsing
  - [ ] Add command history and autocomplete functionality
  - [ ] Integrate with make hardware-sandbox target

- [ ] **Task 2: Sonicator Control Commands** (AC: 2, 4)
  - [ ] Implement sonicator start/stop/reset commands for all channels
  - [ ] Add amplitude control with validation and safety bounds
  - [ ] Create system status and overview commands

- [ ] **Task 3: Hardware Monitoring Commands** (AC: 3, 7)
  - [ ] Implement real-time signal monitoring with refresh
  - [ ] Add configurable sampling rates and monitoring duration
  - [ ] Create hardware state display and status commands

- [ ] **Task 4: Direct Hardware Control** (AC: 5, 6)
  - [ ] Implement MODBUS register read/write commands
  - [ ] Add direct pin control for GPIO manipulation
  - [ ] Create low-level hardware access and testing commands

- [ ] **Task 5: Debugging and Diagnostics** (AC: 8, 12)
  - [ ] Implement hardware state snapshot functionality
  - [ ] Add logging capabilities with timestamps and state changes
  - [ ] Create diagnostic and debugging helper commands

- [ ] **Task 6: Documentation and Help System** (AC: 11)
  - [ ] Create comprehensive help system with command examples
  - [ ] Add usage documentation and quick-start guide
  - [ ] Document debugging workflows and common use cases

## Dev Notes

### Sandbox CLI Architecture

**CLI Location**: `tools/sandbox/hardware_sandbox_cli.py`
**Make Target**: `make hardware-sandbox`

**CLI Framework**: Python Click or argparse for command-line interface
**Hardware Integration**: HIL test harness and Arduino Test Wrapper

**Command Categories:**
1. **Sonicator Commands**: High-level sonicator control and status
2. **Monitoring Commands**: Real-time signal and register monitoring
3. **Hardware Commands**: Direct pin and register manipulation
4. **Debug Commands**: Diagnostics, snapshots, and logging

### Testing Standards

**Test File Location**: `test/integration/test_sandbox_cli.py`

**Testing Framework**: pytest with CLI interaction testing

**Testing Requirements:**
- CLI command parsing and execution validation
- Hardware control command integration testing
- Monitoring and logging functionality verification
- Error handling and safety bound validation

**Specific Testing Patterns:**
- CLI command execution with expected output validation
- Hardware state verification after command execution
- Error condition testing with invalid commands and parameters
- Integration testing with HIL framework

### Developer Experience Features

**Command Completion:**
- Tab completion for command names and hardware addresses
- History navigation with up/down arrows
- Context-sensitive help and parameter suggestions

**Safety and Validation:**
- Input validation for all hardware control commands
- Safety bounds for amplitude and power settings
- Confirmation prompts for potentially dangerous operations

## Dependencies

**Prerequisites:**
- Story 1.1: Hardware Verification & Pin Matrix Validation completed
- Story 1.2: HIL Test Harness Implementation completed
- Python CLI framework (Click/argparse) available
- Arduino Test Wrapper operational

**Enables:**
- Enhanced debugging and development workflows
- Manual validation of automated test results
- Interactive hardware exploration and characterization

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-10 | 1.0 | Initial story creation for F-002 | Product Owner (Sarah) |

## QA Results

### Review Date: 2025-09-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**STORY READINESS ASSESSMENT** - Story is in Draft status and not ready for implementation review.

**Current Status**: Draft - No implementation has been completed yet.

**Story Quality**: ✅ **EXCELLENT** - Comprehensive CLI story with detailed command structure and excellent developer experience focus.

**Architecture Assessment**: ✅ **OUTSTANDING**

- Comprehensive CLI command structure with clear categories
- Excellent developer experience considerations (autocomplete, history, help)
- Well-designed integration with HIL framework and hardware control
- Detailed technical implementation with practical examples
- Strong focus on debugging and diagnostic capabilities

### Compliance Check

- **Story Structure**: ✅ **PASS** - Complete story with all required sections
- **Acceptance Criteria**: ✅ **PASS** - 12 comprehensive ACs covering all CLI aspects
- **Task Breakdown**: ✅ **PASS** - 6 major tasks with detailed subtasks
- **Technical Documentation**: ✅ **PASS** - Outstanding command structure and examples

### Story Readiness Analysis

**Prerequisites for Implementation**:

1. ✅ Story structure complete and well-defined
2. ✅ Acceptance criteria comprehensive (12 ACs)
3. ✅ Task breakdown detailed and actionable (6 major tasks)
4. ✅ CLI architecture and command structure excellently documented
5. ⚠️ **DEPENDENCY**: Requires Story 0.2 (HIL Test Harness) to be functional
6. ❌ **BLOCKING**: Story status is Draft, not ready for development

**Implementation Readiness Score**: 85/100 (excellent planning, dependency on Story 0.2)

### Dependency Analysis

**CRITICAL DEPENDENCIES**:

- **Story 0.2 HIL Test Harness Setup**: Must be completed with unit test coverage ≥90%
- **Hardware Integration**: Arduino Test Wrapper and HIL framework must be operational
- **CLI Framework**: Python Click or argparse framework selection needed

### Risk Assessment

**LOW RISK** - Excellent planning with clear implementation path.

**Potential Risks**:
- **Medium**: Story 0.2 unit test coverage issues could delay this story
- **Low**: CLI framework integration complexity
- **Low**: Hardware control safety validation

### Gate Status

Gate: **DEPENDENCY_BLOCKED** → docs/qa/gates/0.6-sandbox-cli-manual-testing.yml

### Recommended Status

**⚠️ BLOCKED BY DEPENDENCIES** - Excellent story planning but cannot proceed until Story 0.2 is completed.

**Next Steps**:
1. **Complete Story 0.2** - Resolve HIL test harness unit test coverage issues
2. **Select CLI framework** (recommend Python Click for rich features)
3. **Change status to In Progress** when dependencies are resolved
