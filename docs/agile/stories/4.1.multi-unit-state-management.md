---
# <!-- Generated by •∆• ~•Axovia•ƒløw™•~ -->
id: S-4.1
title: Multi-Unit State Management
status: draft
updated_at: 2025-09-14
version: 1.0
provenance:
  banner: "<!-- Generated by •∆• ~•Axovia•ƒløw™•~ -->"
---
# Story 4.1: Multi-Unit State Management

## Status

Draft

## Story

**As a** Control Systems Engineer,
**I want** coordinated state machines for managing up to 4 sonicator units simultaneously,
**so that** I can ensure safe, efficient, and synchronized operation of multiple sonicators with proper state coordination and conflict resolution.

## Acceptance Criteria

1. State machine implementation for each of 4 sonicator units
2. Master coordination state machine for multi-unit orchestration
3. State synchronization and conflict resolution mechanisms
4. Safe state transitions with validation and interlocks
5. State persistence and recovery after power cycles
6. Real-time state monitoring and reporting via MODBUS
7. Emergency state management and shutdown procedures
8. State machine testing with all possible transitions
9. Performance optimization for concurrent state management
10. Integration with safety systems and overload protection
11. Read-only MODBUS registers expose previous-state context (no auto-resume)
    - System-level (read-only):
      - 0x0005 PREV_ACTIVE_MASK — bitmask of units active before last shutdown
      - 0x0006 LAST_SHUTDOWN_REASON — 0=normal, 1=watchdog, 2=power-loss, 3=e-stop, 4=fault
    - Per-unit (read-only, status block):
      - 0xN14 PREV_STATE — last recorded unit state (enum sonicator_state_t)
      - 0xN15 PERSISTED_AMPLITUDE — last setpoint before shutdown
      - 0xN16 LAST_FAULT_CODE — last recorded fault code for unit
      - 0xN17 LAST_STATE_TIMESTAMP_LO — low 16 bits of timestamp (hi optional)
    - Safety rule: On power-up, master=IDLE and all units=STOPPED regardless of persisted values

## Tasks / Subtasks

- [ ] Task 1: Individual Sonicator State Machines (AC: 1, 4)
  - [ ] Design state machine for single sonicator unit
  - [ ] Implement states: OFF, STARTING, RUNNING, STOPPING, FAULT, MAINTENANCE
  - [ ] Create state transition validation and safety checks
  - [ ] Implement state-specific behavior and actions
  - [ ] Add state machine unit tests and validation

- [ ] Task 2: Master Coordination State Machine (AC: 2, 3)
  - [ ] Design master state machine for multi-unit coordination
  - [ ] Implement coordination states: IDLE, COORDINATED_START, RUNNING, EMERGENCY_STOP
  - [ ] Create state synchronization mechanisms
  - [ ] Implement conflict resolution algorithms
  - [ ] Add master state machine testing

- [ ] Task 3: State Persistence and Recovery (AC: 5, 6)
  - [ ] Implement state persistence to EEPROM
  - [ ] Create power-cycle recovery procedures
  - [ ] Add state validation after recovery
  - [ ] Implement MODBUS state reporting
  - [ ] Create state history and logging

- [ ] Task 4: Emergency and Safety Integration (AC:` 7, 10)
  - [ ] Implement emergency shutdown state transitions
  - [ ] Create safety interlock integration
  - [ ] Add overload protection state handling
  - [ ] Implement fault isolation and recovery
  - [ ] Create safety system testing

- [ ] Task 5: Performance and Testing (AC: 8, 9)
  - [ ] Optimize state machine performance for real-time operation
  - [ ] Create comprehensive state transition testing
  - [ ] Implement concurrent operation validation
  - [ ] Add performance monitoring and metrics
  - [ ] Create load testing for 4-unit operation

## Dev Notes

### Testing Standards

- **Test Framework**: Unity with state machine test harness
- **Test Location**: test/unit/state_machines/ and test/integration/coordination/
- **Coverage Target**: 100% state transition coverage required
- **State Testing**: All possible state combinations and transitions
- **Performance Testing**: Real-time operation validation under load

### Architecture Context

- **State Management**: Hierarchical state machines with master coordination
- **Memory Usage**: Efficient state storage in constrained 2KB SRAM
- **Real-time**: State transitions within deterministic timing bounds
- **Communication**: MODBUS register mapping for state reporting
- **Safety Integration**: Integration with hardware safety systems

### Technical Constraints

- **Memory Limitations**: Minimize state machine memory footprint
- **Real-time Performance**: State transitions ≤10ms for responsiveness
- **Safety Critical**: All state transitions must be safe and validated
- **Concurrent Operation**: Support 4 simultaneous state machines
- **Fault Tolerance**: Graceful degradation and recovery capabilities

### File Locations

- **State Machine Headers**: include/state_machines/ (state machine interfaces)
- **State Machine Source**: src/state_machines/ (implementation files)
- **State Tests**: test/unit/state_machines/ (unit tests)
- **Integration Tests**: test/integration/coordination/ (multi-unit tests)
- **State Configuration**: include/config/state_config.h (state definitions)

### State Machine Design

```c
// Sonicator State Enumeration
typedef enum {
    SONICATOR_STATE_OFF,
    SONICATOR_STATE_STARTING,
    SONICATOR_STATE_RUNNING,
    SONICATOR_STATE_STOPPING,
    SONICATOR_STATE_FAULT,
    SONICATOR_STATE_MAINTENANCE
} sonicator_state_t;

// Master Coordination States
typedef enum {
    MASTER_STATE_IDLE,
    MASTER_STATE_COORDINATED_START,
    MASTER_STATE_RUNNING,
    MASTER_STATE_EMERGENCY_STOP,
    MASTER_STATE_FAULT_ISOLATION
} master_state_t;

// State Machine Interface
typedef struct {
    sonicator_state_t current_state;
    sonicator_state_t previous_state;
    uint32_t state_entry_time;
    uint16_t fault_code;
    bool state_change_pending;
} sonicator_state_machine_t;
```

### State Transition Matrix

- **Valid Transitions**: Defined transition matrix for safety
- **Transition Guards**: Conditions that must be met for transitions
- **Transition Actions**: Actions performed during state changes
- **Timeout Handling**: Maximum time limits for each state
- **Error Recovery**: Automatic recovery from transient faults

### MODBUS State Reporting

- **State Registers**: Individual sonicator state reporting
- **Master State**: Overall system coordination state
- **State History**: Recent state change log
- **Fault Information**: Detailed fault codes and timestamps
- **Performance Metrics**: State transition timing and statistics

### Previous Story Insights

- Depends on Epic 1 HAL and basic control implementation
- Foundation for all multi-unit coordination features
- Critical for safety and operational reliability
- Must integrate with existing single-unit control patterns

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-10 | 1.0 | Created story for multi-unit state management | Product Owner |
