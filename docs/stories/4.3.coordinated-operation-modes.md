# Story 4.3: Coordinated Operation Modes - Synchronized Start/Stop Sequences with Timing Control

## Status

Draft

## Story

**As a** Production Manager,
**I want** coordinated operation modes that enable synchronized start/stop sequences across multiple sonicator units with configurable timing control,
**so that** I can optimize production workflows through coordinated multi-unit operation while maintaining precise timing control and operational efficiency.

## Acceptance Criteria

1. Synchronized start sequences with configurable timing delays between units
2. Coordinated stop sequences with proper shutdown timing and safety protocols
3. Multiple operation modes: individual, sequential, simultaneous, and custom patterns
4. Configurable timing parameters for start/stop delays and sequencing
5. Master control interface for coordinated operation commands via MODBUS
6. Real-time coordination status monitoring and feedback
7. Safety interlocks preventing unsafe coordinated operation scenarios
8. Coordination failure detection and automatic fallback to individual control
9. Performance optimization maintaining <100ms MODBUS response times
10. Operational mode persistence and recovery after power cycles

## Tasks / Subtasks

- [ ] Task 1: Coordination Mode Architecture (AC: 3, 5)
  - [ ] Design coordinated operation mode architecture and state management
  - [ ] Implement multiple operation modes (individual/sequential/simultaneous/custom)
  - [ ] Create master control interface for coordinated operation commands
  - [ ] Implement MODBUS interface for coordination mode control
  - [ ] Add operation mode selection and configuration management

- [ ] Task 2: Synchronized Start/Stop Sequences (AC: 1, 2, 4)
  - [ ] Implement synchronized start sequences with configurable timing delays
  - [ ] Create coordinated stop sequences with proper shutdown protocols
  - [ ] Add configurable timing parameters for sequence control
  - [ ] Implement start/stop delay management and sequencing logic
  - [ ] Create timing validation and safety checks for sequences

- [ ] Task 3: Real-time Coordination Monitoring (AC: 6, 8)
  - [ ] Implement real-time coordination status monitoring and feedback
  - [ ] Add coordination failure detection and diagnostic capabilities
  - [ ] Create automatic fallback to individual control on coordination failure
  - [ ] Implement coordination health monitoring and status reporting
  - [ ] Add coordination event logging and troubleshooting support

- [ ] Task 4: Safety and Validation Systems (AC: 7)
  - [ ] Implement safety interlocks for coordinated operation scenarios
  - [ ] Add validation logic preventing unsafe coordination patterns
  - [ ] Create safety checks for multi-unit coordination commands
  - [ ] Implement emergency coordination shutdown capabilities
  - [ ] Add coordination safety monitoring and fault detection

- [ ] Task 5: Performance and Persistence (AC: 9, 10)
  - [ ] Optimize coordination performance for <100ms MODBUS response times
  - [ ] Implement operational mode persistence and recovery mechanisms
  - [ ] Add coordination state recovery after power cycles
  - [ ] Create performance monitoring for coordinated operations
  - [ ] Implement efficient coordination algorithms and timing control

## Dev Notes

### Previous Story Insights
- Multi-unit state management (Story 4.1) provides state coordination framework
- Individual control systems (Story 4.2) provide foundation for per-unit control
- Coordination builds on individual unit control with timing and sequencing
- Safety systems must prevent coordination conflicts and unsafe operations

### Architecture Context

**Coordination Architecture**: Master coordination with individual unit control [Source: docs/architecture/architecture.md]
- Master coordination state machine for multi-unit sequencing
- Individual unit control integration with coordination layer
- Timing control system with configurable delays and sequences
- Safety interlock integration for coordinated operation validation

**Operation Mode Design**: Multiple coordination patterns and timing control
- Individual mode: Independent unit operation without coordination
- Sequential mode: Units start/stop in sequence with configurable delays
- Simultaneous mode: All units start/stop together with synchronized timing
- Custom mode: User-defined patterns with flexible timing configuration

**MODBUS Coordination Interface**: Master control registers for coordination [Source: docs/architecture/architecture.md]
- Global coordination registers: 0x0010-0x001F for master control
- Coordination mode selection and configuration registers
- Timing parameter registers for sequence control
- Coordination status and monitoring registers

### Technical Specifications

**Coordination Mode Structure**:
```cpp
enum CoordinationMode {
  INDIVIDUAL,    // Independent unit operation
  SEQUENTIAL,    // Sequential start/stop with delays
  SIMULTANEOUS,  // Synchronized start/stop
  CUSTOM         // User-defined coordination pattern
};

struct CoordinationConfig {
  CoordinationMode mode;
  uint16_t start_delays[4];     // Start delay per unit (ms)
  uint16_t stop_delays[4];      // Stop delay per unit (ms)
  bool safety_interlocks_enabled;
  uint8_t active_unit_mask;     // Which units participate
};
```

**Timing Control System**:
- Start sequence delays: 0-10000ms per unit with 1ms resolution
- Stop sequence delays: 0-5000ms per unit with 1ms resolution
- Timing validation and safety checks
- Sequence abort and emergency stop capabilities

**Coordination Commands**:
- Master start command with coordination mode selection
- Master stop command with coordinated shutdown
- Mode configuration and timing parameter setup
- Coordination status query and monitoring

**Safety Integration**:
- Coordination safety interlocks and validation
- Unsafe operation pattern detection and prevention
- Emergency coordination shutdown capabilities
- Coordination failure detection and fallback mechanisms

### File Locations
- **Coordination Manager**: `src/control/CoordinationManager.cpp` (main coordination logic)
- **Operation Modes**: `src/control/OperationModes.cpp` (mode implementation and management)
- **Timing Control**: `src/control/TimingController.cpp` (sequence timing and delays)
- **Safety Systems**: `src/safety/CoordinationSafety.cpp` (coordination safety validation)
- **MODBUS Interface**: `src/communication/CoordinationModbus.cpp` (coordination register interface)
- **Configuration**: `src/config/CoordinationConfig.cpp` (mode and timing configuration)

### Testing Requirements
- **Unit Testing**: Coordination logic and timing control functionality
- **Integration Testing**: Multi-unit coordination with individual control systems
- **HIL Testing**: Hardware-in-the-loop testing with 4 sonicator coordination
- **Timing Testing**: Sequence timing validation and performance testing
- **Safety Testing**: Coordination safety interlocks and failure scenarios

### Technical Constraints
- **Timing Precision**: 1ms resolution for start/stop sequence timing
- **Response Time**: <100ms MODBUS response for coordination commands
- **Safety**: Coordination safety interlocks and unsafe operation prevention
- **Reliability**: Coordination failure detection and automatic fallback
- **Performance**: Efficient coordination algorithms within ATmega32A constraints

### Coordination Features
- **Multiple Modes**: Individual, sequential, simultaneous, and custom operation
- **Timing Control**: Configurable delays and sequencing for optimal operation
- **Safety Integration**: Coordination safety interlocks and validation
- **Status Monitoring**: Real-time coordination status and health monitoring
- **Failure Handling**: Automatic fallback and recovery mechanisms

### Operation Mode Details

**Individual Mode**:
- Each unit operates independently without coordination
- No timing constraints or sequencing
- Full individual control maintained
- Default fallback mode for coordination failures

**Sequential Mode**:
- Units start/stop in sequence with configurable delays
- Optimized for power management and system stability
- Configurable start and stop delay timing
- Safety validation for sequence parameters

**Simultaneous Mode**:
- All units start/stop together with synchronized timing
- Maximum production capacity operation
- Power system load management integration
- Coordinated safety monitoring and shutdown

**Custom Mode**:
- User-defined coordination patterns and timing
- Flexible configuration for specific process requirements
- Advanced timing control and sequencing options
- Custom safety validation and monitoring

### Integration Points
- **State Management**: Integration with multi-unit state coordination (Story 4.1)
- **Individual Control**: Coordination with individual unit control systems (Story 4.2)
- **Safety Systems**: Integration with safety interlocks and monitoring
- **MODBUS Communication**: Master coordination command interface
- **Monitoring Systems**: Real-time coordination status and performance monitoring

### Performance Optimization
- **Efficient Algorithms**: Optimized coordination logic for fast response
- **Memory Management**: Efficient data structures for coordination state
- **Timing Control**: Precise timing implementation with minimal overhead
- **Communication**: Optimized MODBUS register access for coordination
- **Real-time Operation**: Deterministic timing for coordinated sequences

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Created story for coordinated operation modes and timing control | Bob (Scrum Master) |
