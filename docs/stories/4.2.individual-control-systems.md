# Story 4.2: Individual Control Systems - Independent Start/Stop/Amplitude Control Per Unit

## Status

Draft

## Story

**As a** Sonicator Operator,
**I want** independent control systems for each of the 4 sonicator units with individual start/stop/amplitude control capabilities,
**so that** I can operate each sonicator independently according to specific process requirements while maintaining precise control over individual unit parameters.

## Acceptance Criteria

1. Independent start/stop control for each of 4 sonicator units via MODBUS commands
2. Individual amplitude control with 0-100% setpoint range per unit
3. Per-unit parameter validation and safety limit enforcement
4. Individual unit status monitoring and feedback for each sonicator
5. Independent fault handling and recovery procedures per unit
6. Real-time parameter adjustment capabilities during operation
7. Individual unit calibration and configuration management
8. Per-unit operational limits and safety threshold enforcement
9. Independent unit diagnostics and health monitoring
10. Individual unit control response times <100ms for all operations

## Tasks / Subtasks

- [ ] Task 1: Individual Unit Control Interface (AC: 1, 2, 6)
  - [ ] Implement independent start/stop control for each sonicator unit
  - [ ] Create individual amplitude control with 0-100% setpoint management
  - [ ] Add real-time parameter adjustment capabilities during operation
  - [ ] Implement MODBUS command interface for individual unit control
  - [ ] Create per-unit control validation and command processing

- [ ] Task 2: Parameter Validation and Safety Systems (AC: 3, 8)
  - [ ] Implement per-unit parameter validation and range checking
  - [ ] Add safety limit enforcement for amplitude and operational parameters
  - [ ] Create individual unit operational limits and threshold management
  - [ ] Implement parameter bounds checking and validation
  - [ ] Add safety interlock integration for individual unit protection

- [ ] Task 3: Individual Status Monitoring (AC: 4, 9)
  - [ ] Implement individual unit status monitoring and feedback systems
  - [ ] Create per-unit diagnostics and health monitoring capabilities
  - [ ] Add individual unit operational status reporting
  - [ ] Implement real-time status updates for each sonicator unit
  - [ ] Create individual unit performance monitoring and metrics

- [ ] Task 4: Fault Handling and Recovery (AC: 5)
  - [ ] Implement independent fault detection and handling per unit
  - [ ] Create individual unit recovery procedures and automation
  - [ ] Add per-unit fault isolation and containment mechanisms
  - [ ] Implement individual unit fault logging and reporting
  - [ ] Create unit-specific error recovery and restart procedures

- [ ] Task 5: Configuration and Calibration (AC: 7, 10)
  - [ ] Implement individual unit calibration and configuration management
  - [ ] Add per-unit configuration storage and retrieval
  - [ ] Create individual unit calibration procedures and validation
  - [ ] Optimize control response times for <100ms operation
  - [ ] Implement unit-specific parameter tuning and optimization

## Dev Notes

### Previous Story Insights
- Multi-unit state management (Story 4.1) provides coordination framework
- Single sonicator control (Story 1.4) provides foundation for individual unit control
- Hardware abstraction layer established for sonicator interface
- MODBUS communication framework operational for individual unit commands

### Architecture Context

**Individual Unit Control Architecture**: ATmega32A embedded control system [Source: docs/architecture/architecture.md]
- Individual sonicator control classes for 4 units
- Hardware abstraction layer for per-unit interface
- MODBUS register mapping for individual unit control
- Real-time control loop implementation with cooperative scheduling

**MODBUS Register Structure**: Per-unit control and status registers [Source: docs/architecture/architecture.md]
- Unit 1: 0x0100-0x011F (control and status registers)
- Unit 2: 0x0200-0x021F (control and status registers)
- Unit 3: 0x0300-0x031F (control and status registers)
- Unit 4: 0x0400-0x041F (control and status registers)
- Individual register mapping for start/stop/amplitude control

**Hardware Interface Design**: Individual sonicator connections [Source: config/hardware-config.yaml]
- Per-unit control signals (start/stop/amplitude/reset)
- Individual status monitoring (overload/frequency/power)
- Independent hardware interfaces for each sonicator unit
- Isolated control circuits for safety and reliability

### Technical Specifications

**Individual Control Interface**:
```cpp
class SonicatorUnit {
private:
  uint8_t unit_id;
  uint16_t amplitude_setpoint;  // 0-1000 (0-100.0%)
  bool start_command;
  bool stop_command;
  SonicatorState current_state;
  
public:
  void setAmplitude(uint16_t amplitude);
  void startUnit();
  void stopUnit();
  SonicatorStatus getStatus();
  bool isOperational();
};
```

**Parameter Control Ranges**:
- Amplitude: 0-100% with 0.1% resolution
- Start/Stop: Boolean commands with immediate response
- Safety limits: Configurable per unit with validation
- Response time: <100ms for all control operations

**Individual Unit Registers**:
- Control registers: Start/stop commands, amplitude setpoint
- Status registers: Current state, operational parameters, fault codes
- Configuration registers: Calibration data, safety limits
- Diagnostic registers: Performance metrics, health status

**Safety and Validation**:
- Parameter range validation before command execution
- Safety limit enforcement with configurable thresholds
- Individual unit fault detection and isolation
- Emergency stop capability for individual units

### File Locations
- **Unit Control**: `src/control/SonicatorUnit.cpp` (individual unit control implementation)
- **Control Interface**: `src/control/IndividualControlInterface.cpp` (control command processing)
- **Parameter Management**: `src/control/ParameterManager.cpp` (parameter validation and limits)
- **Status Monitoring**: `src/monitoring/UnitStatusMonitor.cpp` (individual unit monitoring)
- **MODBUS Interface**: `src/communication/UnitModbusInterface.cpp` (per-unit register handling)
- **Hardware Interface**: `src/hal/SonicatorUnitHAL.cpp` (hardware abstraction per unit)

### Testing Requirements
- **Unit Testing**: Individual control functionality and parameter validation
- **Integration Testing**: MODBUS interface and hardware integration per unit
- **HIL Testing**: Hardware-in-the-loop testing with individual sonicator simulation
- **Performance Testing**: Control response time validation (<100ms requirement)
- **Safety Testing**: Parameter validation and safety limit enforcement

### Technical Constraints
- **Response Time**: <100ms for all individual unit control operations
- **Memory**: Efficient implementation within ATmega32A constraints
- **Safety**: Individual unit safety limits and fault isolation
- **Precision**: 0.1% amplitude resolution with stable control
- **Reliability**: Independent operation without cross-unit interference

### Individual Control Features
- **Independent Operation**: Each unit operates completely independently
- **Precise Control**: 0.1% amplitude resolution with real-time adjustment
- **Safety Integration**: Individual safety limits and fault protection
- **Status Monitoring**: Real-time operational status and health monitoring
- **Configuration Management**: Per-unit calibration and parameter storage

### Parameter Management
- **Amplitude Control**: 0-100% range with precise setpoint control
- **Operational Limits**: Configurable safety thresholds per unit
- **Calibration Data**: Individual unit calibration and compensation
- **Validation Logic**: Parameter bounds checking and safety validation
- **Real-time Adjustment**: Dynamic parameter changes during operation

### Integration Points
- **State Management**: Integration with multi-unit state coordination (Story 4.1)
- **Hardware Interface**: Individual sonicator hardware control and monitoring
- **MODBUS Communication**: Per-unit register interface for external control
- **Safety Systems**: Individual unit safety and fault handling integration
- **Monitoring Systems**: Real-time status and performance monitoring

### Individual Unit Features
- **Start/Stop Control**: Independent unit start and stop commands
- **Amplitude Management**: Precise amplitude control with real-time adjustment
- **Status Reporting**: Comprehensive operational status and health monitoring
- **Fault Handling**: Individual fault detection, isolation, and recovery
- **Configuration**: Per-unit calibration and parameter management

### Performance Optimization
- **Control Loop**: Optimized control algorithms for fast response
- **Memory Usage**: Efficient data structures for ATmega32A constraints
- **Communication**: Optimized MODBUS register access and updates
- **Hardware Interface**: Efficient hardware abstraction and control
- **Real-time Operation**: Cooperative scheduling for deterministic timing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Created story for individual sonicator control systems | Bob (Scrum Master) |
