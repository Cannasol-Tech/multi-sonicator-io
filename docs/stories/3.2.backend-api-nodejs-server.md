# Story 3.2: Backend API - Node.js Server for Hardware Communication

## Status

Draft

## Story

**As a** Web UI Frontend Developer,
**I want** a robust Node.js backend API server that provides RESTful endpoints and WebSocket communication for hardware control and monitoring,
**so that** the React frontend can seamlessly communicate with the ATmega32A sonicator controller through standardized API interfaces with real-time updates and comprehensive error handling.

## Acceptance Criteria

1. Node.js Express server with TypeScript for type safety and maintainability
2. RESTful API endpoints for all hardware control operations (start/stop/amplitude/status)
3. WebSocket server for real-time hardware status updates and live monitoring
4. Hardware abstraction layer integration with existing Arduino test wrapper
5. CORS configuration for frontend-backend communication
6. Comprehensive error handling and logging for debugging and monitoring
7. API documentation with endpoint specifications and response formats
8. Configuration management for hardware connection and server settings
9. Health check endpoints for system monitoring and diagnostics
10. Integration with existing HIL testing framework and BDD test automation

## Tasks / Subtasks

- [ ] Task 1: Node.js Server Foundation (AC: 1, 5, 8)
  - [ ] Initialize Node.js project with TypeScript configuration
  - [ ] Set up Express server with middleware (CORS, JSON parsing, error handling)
  - [ ] Configure development and production environments
  - [ ] Implement configuration management service
  - [ ] Set up logging infrastructure with structured logging

- [ ] Task 2: Hardware Integration Layer (AC: 4, 6)
  - [ ] Create hardware interface adapter for Arduino test wrapper communication
  - [ ] Implement serial communication handling with error recovery
  - [ ] Add hardware connection management and reconnection logic
  - [ ] Create hardware command abstraction layer
  - [ ] Implement hardware state management and caching

- [ ] Task 3: RESTful API Endpoints (AC: 2, 7, 9)
  - [ ] Implement health check and system status endpoints
  - [ ] Create hardware control endpoints (start/stop/amplitude/reset)
  - [ ] Add hardware monitoring endpoints (pin states, connection status)
  - [ ] Implement configuration management endpoints
  - [ ] Create API documentation with OpenAPI/Swagger specification

- [ ] Task 4: WebSocket Real-time Communication (AC: 3, 6)
  - [ ] Set up WebSocket server with connection management
  - [ ] Implement real-time hardware status broadcasting
  - [ ] Add WebSocket error handling and reconnection support
  - [ ] Create WebSocket message protocol for frontend communication
  - [ ] Implement WebSocket authentication and session management

- [ ] Task 5: Testing Integration and Documentation (AC: 7, 10)
  - [ ] Integrate with existing HIL testing framework
  - [ ] Add support for BDD test automation API endpoints
  - [ ] Create comprehensive API documentation
  - [ ] Implement test execution and monitoring endpoints
  - [ ] Add test result reporting and history management

## Dev Notes

### Previous Story Insights
- Frontend (Story 3.1) is complete and functional, requiring backend API integration
- Existing backend implementation found in `web-ui/backend/` with comprehensive functionality
- Current backend already implements most required features but may need enhancement
- Integration with HIL testing framework and BDD automation already established

### Architecture Context

**Backend Framework**: Node.js with Express and TypeScript [Source: web-ui/backend/src/server.ts]
- Express server with HTTP and WebSocket support
- TypeScript for type safety and development experience
- CORS middleware for frontend communication
- Structured error handling and logging

**Hardware Integration**: Arduino Test Wrapper Communication [Source: web-ui/backend/src/adapters/HardwareInterface.ts]
- Serial communication with Arduino test wrapper
- Hardware command abstraction and state management
- Real-time pin state monitoring and control
- Connection management with automatic reconnection

**API Architecture**: RESTful endpoints with WebSocket real-time updates [Source: web-ui/backend/src/routes/index.ts]
- Comprehensive REST API for hardware control
- WebSocket server for real-time status updates
- Health check and monitoring endpoints
- Configuration management endpoints

**Testing Integration**: HIL Framework and BDD Automation [Source: web-ui/backend/src/services/TestAutomationService.ts]
- Integration with existing BDD test scenarios
- Test execution and monitoring capabilities
- Test result reporting and history management
- Support for automated test execution

### Technical Specifications

**Server Configuration**:
- Port: 3001 (configurable via environment)
- WebSocket endpoint: `/ws`
- API base path: `/api`
- CORS: Development mode allows localhost:3000

**Hardware Interface**:
- Serial communication with Arduino test wrapper
- Command protocol for hardware control
- Real-time pin state monitoring
- Hardware configuration management via `config/hardware-config.yaml`

**API Endpoints** [Source: web-ui/docs/API.md]:
- `GET /api/health` - System health and status
- `GET /api/pins` - Pin state monitoring
- `POST /api/command` - Hardware command execution
- `POST /api/ping` - Hardware communication test
- `GET /api/config` - Configuration management
- Test automation endpoints for BDD scenarios

**WebSocket Protocol**:
- Real-time hardware status updates
- Pin state change notifications
- Test execution progress updates
- Connection status and error notifications

### File Locations
- **Server Entry**: `web-ui/backend/src/server.ts` (main server file)
- **Routes**: `web-ui/backend/src/routes/` (API endpoint definitions)
- **Services**: `web-ui/backend/src/services/` (business logic and hardware integration)
- **Adapters**: `web-ui/backend/src/adapters/` (hardware interface abstraction)
- **WebSocket**: `web-ui/backend/src/websocket/` (real-time communication)
- **Configuration**: `web-ui/backend/src/config/` (configuration management)
- **Tests**: `web-ui/backend/src/__tests__/` (unit and integration tests)

### Testing Requirements
- **Test Framework**: Jest for unit testing, pytest for integration testing
- **Test Location**: `web-ui/backend/src/__tests__/` for unit tests
- **Coverage Target**: â‰¥85% code coverage for all backend services
- **Integration Testing**: HIL framework integration with BDD scenarios
- **API Testing**: Endpoint testing with mock hardware interface

### Technical Constraints
- **Performance**: API response times <100ms for hardware commands
- **Reliability**: Automatic reconnection and error recovery
- **Scalability**: Support for concurrent WebSocket connections
- **Security**: Input validation and error handling
- **Compatibility**: Integration with existing HIL testing framework

### Hardware Configuration
- **Source of Truth**: `config/hardware-config.yaml` for pin assignments
- **Arduino Interface**: Serial communication with test wrapper
- **Pin Mapping**: ATmega32A DUT to Arduino test wrapper connections
- **Signal Types**: Digital I/O, analog monitoring, PWM control

### Integration Points
- **Frontend**: React application via REST API and WebSocket
- **Hardware**: Arduino test wrapper via serial communication
- **Testing**: HIL framework and BDD test automation
- **Configuration**: Hardware configuration management system

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-13 | 1.0 | Created story for Node.js backend API development | Bob (Scrum Master) |
