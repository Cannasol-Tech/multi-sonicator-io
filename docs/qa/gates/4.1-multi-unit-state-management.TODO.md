# TODO — Story 4.1: Multi‑Unit State Management (Developer Checklist)

Context
- Story: docs/agile/stories/4.1.multi-unit-state-management.md
- Gate: docs/qa/gates/4.1-multi-unit-state-management.yml (CONCERNS)
- HIL Waiver: active (scope: hil) — hardware temporarily unavailable; proceed with software + CI validation

How to Use
- Complete all non‑hardware tasks now; leave HIL tests @pending with clear TODO markers.
- Target CI status contexts: ci/unit, ci/integration, ci/acceptance, standards/check, lint/markdown.
- Coverage: ≥85% statement coverage for new/changed code per SOP.

Checklist
1) AC‑5/6 — Persistence & Safe Recovery
- [ ] Implement EEPROM persistence of required state/context
- [ ] Implement safe boot recovery; ensure no auto‑resume on power‑up (master=IDLE, units=STOPPED)
- [ ] Add unit tests for persistence/write/read/validation paths
- [ ] Add integration test simulating power‑cycle recovery behavior
- [ ] Update BDD scenarios for recovery (activate; may skip HIL‑only steps)
- [ ] Update traceability matrix to map tests → AC‑5/6

2) AC‑7/10 — E‑STOP & Safety Interlocks (software first)
- [ ] Implement E‑STOP transitions and fault isolation paths
- [ ] Integrate safety interlock checks in transitions/guards
- [ ] Add unit + integration tests covering E‑STOP, interlock inhibit, recovery
- [ ] Annotate HIL scenarios as @pending with TODO: Awaiting hardware availability

3) AC‑13 — Partial Success Validation
- [ ] Activate BDD scenarios (remove @pending) for partial success behavior
- [ ] Ensure coordinated START continues for successful units; failures go to error per policy
- [ ] Add logs/metrics artifacts to aid debugging in CI

4) AC‑8/9 — Transition Coverage & Timing
- [ ] Add tests to cover all valid transitions and guard conditions
- [ ] Add timing assertions proving ≤10ms state transition processing (simulation acceptable)
- [ ] Capture and publish timing results in CI artifacts

5) AC‑11 — MODBUS Previous‑State (RO) Integration
- [ ] Add integration tests verifying RO behavior and correct address mapping
- [ ] Ensure addresses match include/register_map.h (no drift)

6) CI, Coverage, and Reporting
- [ ] Ensure `make test-unit` and `make test-acceptance` run cleanly in CI
- [ ] Reach ≥85% coverage; update test report per docs/sop/sw-testing.md
- [ ] Update STORY Change Log and mark completed tasks in story file

References
- Unit tests: test/unit/control/test_multi_sonicator.cpp, test/unit/test_prev_state_registers.cpp
- Acceptance: test/acceptance/features/multi_unit_state_management.feature
- Implementation: src/modules/control/multi_sonicator.cpp
- Register map: include/register_map.h
- SOPs: docs/sop/sw-testing.md, docs/sop/release-format.md

Notes
- Hardware/HIL steps explicitly deferred; keep scenarios tagged @pending with a TODO note linking back to this file.
