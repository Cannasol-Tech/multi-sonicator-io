# Test Design: Story 1.4 - Single Sonicator Control

Date: 2025-09-14
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 17
- Unit tests: 5 (29%)
- Integration tests: 4 (24%) 
- HIL tests: 8 (47%)
- Priority distribution: P0: 10, P1: 5, P2: 2

## Test Scenarios by Acceptance Criteria

### AC1: Start/stop commands change output state reliably and within expected timing

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification              |
|--------------|-------------|---------|-----------------------------------------|----------------------------|
| 1.4-UNIT-001 | Unit        | P0      | State machine transitions               | Pure state logic validation|
| 1.4-INT-001  | Integration | P0      | HAL control signal validation           | Hardware abstraction test  |
| 1.4-HIL-001  | HIL         | P0      | Physical start/stop signal verification | End-to-end hardware test   |
| 1.4-HIL-002  | HIL         | P1      | Start/stop timing validation            | Timing requirement test    |

### AC2: Amplitude setpoint accepted and applied within tolerance (± 2%)

#### Scenarios

| ID           | Level       | Priority | Test                              | Justification              |
|--------------|-------------|---------|-----------------------------------|----------------------------|
| 1.4-UNIT-002 | Unit        | P0      | Amplitude calculation validation   | Pure calculation logic     |
| 1.4-HIL-003  | HIL         | P0      | Amplitude PWM output verification  | Hardware PWM validation    |
| 1.4-HIL-004  | HIL         | P1      | Amplitude tolerance boundary test  | ±2% tolerance verification |
| 1.4-HIL-005  | HIL         | P2      | Amplitude clamping (20-100%)      | Edge case validation       |

### AC3: Telemetry registers report current state and fault conditions

#### Scenarios

| ID           | Level       | Priority | Test                                 | Justification           |
|--------------|-------------|---------|--------------------------------------|-------------------------|
| 1.4-UNIT-003 | Unit        | P0      | Telemetry data structure validation  | Data structure logic    |
| 1.4-INT-002  | Integration | P0      | HAL telemetry interface validation   | Multi-component test    |
| 1.4-HIL-006  | HIL         | P0      | Real-time telemetry verification     | Hardware integration    |

### AC4: MODBUS RTU operations for controls/telemetry succeed within 100ms

#### Scenarios

| ID           | Level       | Priority | Test                                  | Justification          |
|--------------|-------------|---------|---------------------------------------|------------------------|
| 1.4-UNIT-004 | Unit        | P1      | MODBUS register mapping validation    | Register logic test    |
| 1.4-INT-003  | Integration | P0      | MODBUS bridge communication           | Component interaction  |
| 1.4-HIL-007  | HIL         | P0      | MODBUS timing compliance (<100ms)     | Performance requirement|

### AC5: HIL acceptance tests validate the full control loop on hardware

#### Scenarios

| ID           | Level       | Priority | Test                                    | Justification            |
|--------------|-------------|---------|-----------------------------------------|--------------------------|
| 1.4-INT-004  | Integration | P0      | End-to-end control loop simulation     | Full system integration  |
| 1.4-HIL-008  | HIL         | P0      | Complete HIL test suite execution      | Hardware validation      |

## Additional Edge Case Scenarios

| ID           | Level       | Priority | Test                                  | Justification           |
|--------------|-------------|---------|---------------------------------------|-------------------------|
| 1.4-UNIT-005 | Unit        | P2      | Error condition handling              | Error path validation   |
| 1.4-HIL-009  | HIL         | P1      | Overload condition response           | Safety system test      |
| 1.4-HIL-010  | HIL         | P1      | Recovery from communication failure   | Fault tolerance test    |

## Risk Coverage

Test scenarios mapped to identified risks:
- **TECH-005 (Memory constraints)**: Extended runtime testing in HIL-008
- **REL-002 (Race conditions)**: Rapid state transitions in HIL-002
- **TECH-001 (Pin mapping)**: Hardware validation in HIL-001, HIL-003, HIL-006
- **PERF-003 (MODBUS timeout)**: Performance testing in HIL-007
- **OPS-004 (HIL limitation)**: Single-channel focus in all HIL tests

## Recommended Execution Order

1. **P0 Unit tests** (fail fast): 1.4-UNIT-001, 1.4-UNIT-002, 1.4-UNIT-003
2. **P0 Integration tests**: 1.4-INT-001, 1.4-INT-002, 1.4-INT-003, 1.4-INT-004  
3. **P0 HIL tests**: 1.4-HIL-001, 1.4-HIL-003, 1.4-HIL-006, 1.4-HIL-007, 1.4-HIL-008
4. **P1 tests**: 1.4-UNIT-004, 1.4-HIL-002, 1.4-HIL-004, 1.4-HIL-009, 1.4-HIL-010
5. **P2 tests** (as time permits): 1.4-UNIT-005, 1.4-HIL-005

## Test Coverage Analysis

### Strengths
- Complete coverage of all 5 acceptance criteria
- Appropriate test level distribution (shift-left principle applied)
- Risk-based test prioritization
- Hardware-in-the-loop validation for critical paths

### Coverage Gaps
None identified - all acceptance criteria have corresponding test scenarios at appropriate levels.

## Test Execution Requirements

### Hardware Dependencies
- ATmega32A target hardware with Sonicator 4 connections
- Arduino Uno R4 WiFi test harness at /dev/tty.usbmodem2101
- Complete pin matrix connectivity per hardware-config.yaml

### Test Data Requirements
- Valid amplitude ranges (20-100%)
- MODBUS register test patterns
- State machine transition sequences
- Timing validation baselines

### Environmental Requirements
- Real hardware testing environment (not simulation)
- Stable 5V power supply
- Serial communication capability
- HIL framework operational status